package quintaserie

import org.telegram.telegrambots.bots.TelegramWebhookBot
import org.telegram.telegrambots.meta.api.methods.BotApiMethod

import static java.lang.Math.random
import static java.lang.Math.round

import java.util.logging.Logger
import org.telegram.telegrambots.meta.api.methods.send.SendMessage
import org.telegram.telegrambots.meta.api.objects.Update

import static java.lang.System.getenv

class QuintaSerieBot extends TelegramWebhookBot {

	private static final LOGGER = Logger.getLogger QuintaSerieBot.class.simpleName

	@Override
	String getBotUsername() {
		"quinta_serie_bot"
	}

	@Override
	String getBotToken() {
		getenv "BOT_TOKEN"
	}

	@Override
	BotApiMethod onWebhookUpdateReceived(Update update) {
		update.getMessage()?.with { message ->
			final messageText = message.getText()
			final from = message.from
			final responseText = generateAnswer messageText, from, 10

			if (responseText) {
				new SendMessage(chatId: message.getChatId(), text: responseText, replyToMessageId: message.messageId)
			}
		}

		return null
	}

	static def generateAnswer(msg, from, drawFactor) {
		drawNumber().with { n ->
			if (n % drawFactor == 0) {
				null
			}
		}

		switch (msg) {
			case ~/.ão*$/:
				return "@$from.userName seu cu é o mar, meu pau o tubarão"
			case ~/ina*$/:
				return "Tomate cru é vitamina, como você e sua prima"
			default:
				null
		}
	}

	static def drawNumber() {
		round random() * 100.with {n ->
			LOGGER.info "drawn number: $n"
			n
		}
	}

	@Override
	String getBotPath() {
		"https://quinta-serie-bot.herokuapp.com/"
	}
}
